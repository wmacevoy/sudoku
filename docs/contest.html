<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sudoku Contest Generator</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#0f141d;
      --ink:#e8ecf2;
      --muted:#91a0b6;
      --accent:#60a5fa;
      --grid:#1f2430;
      --paper:#ffffff;
    }
    *{box-sizing:border-box;}
    body{margin:0; font-family:"Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--ink); min-height:100vh; display:flex; flex-direction:column; gap:18px; padding:18px;}
    h1{margin:0 0 8px 0;}
    .controls{background:var(--panel); border:1px solid #111827; border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:14px;}
    .controls-header{display:flex; flex-direction:column; gap:6px;}
    .control-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:14px;}
    .option{background:var(--bg); border:1px solid var(--grid); border-radius:10px; padding:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .option h3{grid-column:1 / -1; margin:0 0 6px 0; font-size:14px; color:var(--ink); letter-spacing:0.2px;}
    label{font-size:13px; color:var(--muted); display:flex; flex-direction:column; gap:6px;}
    input[type="text"], input[type="number"]{background:var(--bg); color:var(--ink); border:1px solid var(--grid); border-radius:8px; padding:9px 10px; min-width:120px;}
    input[type="number"]{width:120px;}
    button{cursor:pointer; background:var(--accent); color:#0b0c10; border:1px solid var(--accent); border-radius:10px; padding:10px 16px; font-weight:700;}
    button.secondary{background:transparent; color:var(--ink); border-color:var(--grid);}
    button.active{outline:2px solid var(--accent);}
    .status{font-size:13px; color:var(--muted);}
    #print-area{background:var(--paper); color:#000; border-radius:12px; padding:12px; box-shadow:0 10px 28px rgba(0,0,0,0.4); display:block;}
    .page{
      display:block;
      margin:0 0 16px 0;
      padding:12px;
      border:1px solid #e2e8f0;
      border-radius:10px;
      background:#fff;
      color:#000;
      page-break-after:always;
      break-after:page;
      break-inside:avoid-page;
      page-break-inside:avoid;
      -webkit-region-break-inside:avoid;
      -webkit-column-break-inside:avoid;
    }
    .page + .page{
      break-before:page;
      page-break-before:always;
    }
    .page:last-child{page-break-after:auto;}
    .page h2{margin:0 0 12px 0; font-size:20px; text-align:center;}
    .p-grid{display:grid; grid-template-columns:repeat(9,1fr); grid-template-rows:repeat(9,1fr); width:100%; max-width:900px; aspect-ratio:1/1; border:0.6mm solid #000; margin:0 auto; background:#fff;}
    .p-cell{border:0.12mm solid rgba(0,0,0,0.45); position:relative; display:flex; align-items:center; justify-content:center; font-size:64px; font-weight:700; min-height:64px;}
    .p-cell[data-row="1"], .p-cell[data-row="4"], .p-cell[data-row="7"]{border-top:0.6mm solid #000;}
    .p-cell[data-col="1"], .p-cell[data-col="4"], .p-cell[data-col="7"]{border-left:0.6mm solid #000;}
    .p-cell[data-col="9"]{border-right:0.6mm solid #000;}
    .p-cell[data-row="9"]{border-bottom:0.6mm solid #000;}
    .p-cell.guideline{display:grid; grid-template-columns:1fr 2fr 1fr; grid-template-rows:1fr 2fr 1fr; font-size:16px; gap:0; padding:3px;}
    .p-cell.guideline .mini{display:flex; align-items:center; justify-content:center; line-height:1; color:#000; border:1px solid rgba(0,0,0,0.18); box-sizing:border-box;}
    .p-cell.guideline .mini.blank{color:transparent;}
    .key-faint{opacity:0.2;}
    .keys-title{margin:16px 0 8px 0; font-size:16px; font-weight:700; text-align:center;}
    .page-footer{margin-top:14px; font-size:15px; color:#000; display:flex; flex-direction:column; gap:12px; padding:0 10mm;}
    .footer-line{display:flex; align-items:center; gap:10px; margin:10mm 0;}
    .footer-label{white-space:nowrap; font-weight:700;}
    .footer-blank{flex:1; min-width:160px; border-bottom:1.5px solid #000; height:22px;}
    .footer-blank.short{flex:0 0 200px;}
    .judgement-options{display:flex; align-items:center; gap:14px;}
    .judgement-choice{width:36px; height:36px; border:1.2px solid #000; border-radius:999px; display:flex; align-items:center; justify-content:center; padding:6px;}
    .judgement-icon{width:22px; height:22px; object-fit:contain; filter:grayscale(1);}
    @media print{
      /* Make the printed document independent of the on-screen controls/layout */
      html, body{margin:0 !important; padding:0 !important; width:100% !important; height:auto !important;}
      body{display:block !important; gap:0 !important; background:#fff !important;}
      body > :not(#print-area){display:none !important;}
      #print-area{display:block !important; margin:0 !important; padding:0 !important;}
      /* Force white pages even when user enables "print backgrounds" */
      *{
        background:none !important;
        box-shadow:none !important;
      }
      .page,
      .p-grid,
      .p-cell{
        background:#fff !important;
        color:#000 !important;
      }
      .p-grid{max-width:160mm;}
      @page { margin:12mm; }
      body{background:#fff; padding:0;}
      .controls{display:none !important;}
      #print-area{box-shadow:none; border-radius:0; padding:0;}
      .page{
        border:0;
        border-radius:0;
        padding:12px 10px 16px 10px;
        page-break-after:always;
        break-after:page;
        break-inside:avoid-page;
        page-break-inside:avoid;
        -webkit-region-break-inside:avoid;
        -webkit-column-break-inside:avoid;
      }
      .page:last-child{page-break-after:auto;}
      .page + .page{
        break-before:page;
        page-break-before:always;
      }
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="controls-header">
      <h1>Sudoku Contest Generator</h1>
      <div class="status" id="status">Set counts, then Generate &amp; Print.</div>
    </div>
    <label>Contest title
      <input id="contest-title" type="text" value="Sudoku" />
    </label>
    <div class="control-grid">
      <div class="option">
        <h3>Simple</h3>
        <label>Count
          <input id="count-simple" type="number" min="0" max="999" value="0" />
        </label>
        <label>Copies each
          <input id="copies-simple" type="number" min="1" max="99" value="1" />
        </label>
      </div>
      <div class="option">
        <h3>Easy</h3>
        <label>Count
          <input id="count-easy" type="number" min="0" max="999" value="2" />
        </label>
        <label>Copies each
          <input id="copies-easy" type="number" min="1" max="99" value="20" />
        </label>
      </div>
      <div class="option">
        <h3>Medium</h3>
        <label>Count
          <input id="count-medium" type="number" min="0" max="999" value="2" />
        </label>
        <label>Copies each
          <input id="copies-medium" type="number" min="1" max="99" value="20" />
        </label>
      </div>
      <div class="option">
        <h3>Hard</h3>
        <label>Count
          <input id="count-hard" type="number" min="0" max="999" value="1" />
        </label>
        <label>Copies each
          <input id="copies-hard" type="number" min="1" max="99" value="10" />
        </label>
      </div>
    </div>
    <div class="row">
      <button id="btn-print">Generate & Print</button>
      <button id="btn-guideline" class="secondary"># Guidelines Off</button>
      <button id="btn-practice" type="button" class="secondary" onclick="window.location.href='index.html'">Practice</button>
    </div>
  </div>

  <div id="print-area" aria-live="polite"></div>

  <script type="module">
    import { SudokuEngine, DIGITS } from './sudoku-engine.js';

    const engine = new SudokuEngine();
    const el = (id) => document.getElementById(id);
    const statusEl = el('status');
    const printArea = el('print-area');
    const titleInput = el('contest-title');
    const guidelineBtn = el('btn-guideline');
    let guidelineMode = false;
    const inputs = {
      simple: { count: el('count-simple'), copies: el('copies-simple'), label: 'Simple' },
      easy: { count: el('count-easy'), copies: el('copies-easy'), label: 'Easy' },
      medium: { count: el('count-medium'), copies: el('copies-medium'), label: 'Medium' },
      hard: { count: el('count-hard'), copies: el('copies-hard'), label: 'Hard' }
    };

    function clampInt(val, min, max, fallback) {
      const n = Number(val);
      if (!Number.isFinite(n)) return fallback;
      return Math.min(Math.max(Math.floor(n), min), max);
    }

    function gridHTML(board, opts = {}) {
      const guideline = opts.guideline || false;
      const mode = opts.mode || 'puzzle'; // 'puzzle' or 'key'
      return board
        .map((row, r) =>
          row
            .map((val, c) => {
              const content = val === 0 ? '' : val;
              // Contestant pages: show normal grid; if guidelines are on and empty, show 1-9 minis.
              if (mode === 'puzzle') {
                if (guideline && !content) {
                  const minis = Array.from({ length: 9 }, (_, idx) => {
                    return `<span class="mini blank"></span>`;
                  }).join('');
                  return `<div class="p-cell guideline" data-row="${r + 1}" data-col="${c + 1}">${minis}</div>`;
                }
                return `<div class="p-cell" data-row="${r + 1}" data-col="${c + 1}">${content}</div>`;
              }
              // Guideline overlay for keys: repeat the digit in all mini slots except center.
              const minis = Array.from({ length: 9 }, (_, idx) => {
                const isCenter = idx === 4; // center spot
                const digit = content && !isCenter ? content : '';
                const blank = isCenter;
                return `<span class="mini${blank ? ' blank' : ''}">${digit}</span>`;
              }).join('');
              return `<div class="p-cell guideline" data-row="${r + 1}" data-col="${c + 1}">${minis}</div>`;
            })
            .join('')
        )
        .join('');
    }

    function letterLabel(index) {
      let n = index;
      let label = '';
      do {
        label = String.fromCharCode(65 + (n % 26)) + label;
        n = Math.floor(n / 26) - 1;
      } while (n >= 0);
      return label;
    }

    function generateContest() {
      const title = titleInput.value.trim() || 'Sudoku';
      let letterIndex = 0;
      const specs = Object.entries(inputs).map(([diff, cfg]) => {
        const count = clampInt(cfg.count.value, 0, 999, 0);
        const copies = clampInt(cfg.copies.value, 1, 99, 1);
        cfg.count.value = String(count);
        cfg.copies.value = String(copies);
        return { diff, label: cfg.label, count, copies };
      });

      const puzzles = [];
      for (const spec of specs) {
        const capped = spec.count;
        for (let i = 0; i < capped; i++) {
          const puzzle = engine.createPuzzle(spec.diff);
          const solved = engine.solve(puzzle);
          if (solved.status !== 'unique' || !solved.solution) {
            i--;
            continue;
          }
          const letter = letterLabel(letterIndex); // A, B, ..., Z, AA, AB...
          puzzles.push({
            diff: spec.diff,
            letter,
            puzzle,
            solution: solved.solution,
            copies: spec.copies
          });
          letterIndex++;
        }
      }

      if (!puzzles.length) {
        statusEl.textContent = 'No puzzles requested.';
        printArea.innerHTML = '';
        return;
      }

      const blocks = [];
      for (const p of puzzles) {
        for (let copy = 1; copy <= p.copies; copy++) {
          blocks.push(`
            <div class="page">
              <h2>${title}: Copy ${copy} of Puzzle ${p.letter}</h2>
              <div class="p-grid">${gridHTML(p.puzzle, { guideline: guidelineMode, mode: 'puzzle' })}</div>
              <div class="page-footer">
                <div class="footer-line"><span class="footer-label">Contestant(s):</span><span class="footer-blank"></span></div>
                <div class="footer-line judgement-options">
                  <span class="footer-label">Submit Time / Judgement:</span>
                  <span class="footer-blank short"></span>
                  <span class="judgement-choice" aria-label="Approved">
                    <img class="judgement-icon" src="thumbs-up.svg" alt="Thumbs up" />
                  </span>
                  <span class="judgement-choice" aria-label="Rejected">
                    <img class="judgement-icon" src="thumbs-down.svg" alt="Thumbs down" />
                  </span>
                </div>
              </div>
            </div>
          `);
        }
      }

      for (const p of puzzles) {
        blocks.push(`
          <div class="page">
            <h2>${title}: Key for Puzzle ${p.letter}</h2>
            <div class="p-grid${guidelineMode ? '' : ' key-faint'}">${gridHTML(p.solution, { guideline: guidelineMode, mode: 'key' })}</div>
          </div>
        `);
      }

      printArea.innerHTML = blocks.join('');
      statusEl.textContent = `Generated ${puzzles.length} puzzles across ${puzzles.reduce((sum,p)=>sum+p.copies,0)} copies. ${guidelineMode ? 'Guideline keys on.' : 'Ready to print.'}`;
    }

    function setGuidelineMode(on) {
      guidelineMode = on;
      guidelineBtn.classList.toggle('active', guidelineMode);
      guidelineBtn.textContent = guidelineMode ? '# Guidelines On' : '# Guidelines Off';
    }

    document.getElementById('btn-print').addEventListener('click', () => {
      generateContest();
      window.print();
    });
    guidelineBtn.addEventListener('click', () => {
      setGuidelineMode(!guidelineMode);
      generateContest();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === '#') {
        event.preventDefault();
        setGuidelineMode(!guidelineMode);
        generateContest();
      }
    });
  </script>
</body>
</html>
